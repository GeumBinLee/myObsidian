> [!Info]- 출처 링크
> [🔗 Flutter Zero to Hero.Part 3 🔗](https://medium.com/@NALSengineering/flutter-from-zero-to-hero-part-3-understand-buildcontext-in-4-minutes-472af1df8e02)

> [!Question] 학습 목표
> 모든 `build` 함수에 존재하는 `BuildContext context` 매개변수는 무엇이고, 무엇을 위해 사용하는 걸까?

# Scenario
```dart
import 'package:flutter/material.dart';

// FloatingActionButton을 누르면 글자가 쓰여진 하단 시트가(bottom sheet) 나와야 한다.
void main() {
  runApp(
    MaterialApp(
      home: MyHomePage(),
    ),
  );
}

class MyHomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      floatingActionButton: FloatingActionButton(onPressed: () {
        /* 하단 시트를 보여주는 부분. 하지만 버튼 클릭 시 에러가 뜨며 작동하지 않는다.
        Scaffold.of() called with a context that does not contain a Scaffold.
        No Scaffold ancestor could be found starting from the context
        that was passed to Scaffold.of() */
        Scaffold.of(context).showBottomSheet(
          (context) => const Text('Flutter From Zero to Hero'),
        );
      }),
    );
  }
}
```
- `Scaffold.of(context)` : 이 함수는 `context` 변수를 받아 `Scaffold` 타입 위젯 중 가장 가까운 부모 위젯을 찾아낸다.
- 위 코드는 범위 내에 `Scaffold`가 존재하지 않기 때문에 exception을 throw한 것이다.
- 즉 우리가 잘못된 `context`를 사용해서 exception이 일어난 것이다.
# What is BuildContext?
- `BuildContext`는 플러터가 모든 위젯의 위젯 트리 내 위치를 알 수 있도록 돕는다.
- 앞서 배웠듯 모든 위젯은 `build` 함수를 가진다.
- 그리고 모든 `build` 함수는 `BuildContext`의 인스턴스를 인자로 갖는다.
- 즉 **모든 위젯은 위젯 트리 내에서 해당 위젯의 위치를 나타내는 `BuildContext` 인스턴스를 갖는다.**

# Widget Tree
- 위젯 트리는 위젯이 서로 상대적으로 어떻게 배치되는지(positioned)를 보여준다.
- 위 예제 코드는 아래 이미지와 같은 위젯 트리 모양을 하고 있다.
	![[위젯 트리 예시 1.png|center|600]]
- `BuildContext` 객체가 위젯 트리 내 위젯의 위치를 나타낸다.
- MyHomePage의 컨텍스트를 Scaffold.of 함수에 전달하면, MyHomePage의 모든 부모를 스캔하기 시작한다.
- 그러나 이 경우 찾을 수 있는 유일한 부모가 `Scaffold`가 아닌 `MaterialApp`이라서 예외가 발생한 것이다.
# Fixing the bug: 올바른 `context`를 넘겨보자!
```dart
import 'package:flutter/material.dart';

void main() {
  runApp(
    MaterialApp(
      home: MyHomePage(),
    ),
  );
}

class MyHomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    // FloatingActionButton이 있는 MyButtonWidget의 부모에 Scaffold가 생겼다.
    // 따라서 이제 부모 위젯 중 가장 가까운 Scaffold 조상을 찾을 수 있게 되었다.
    return Scaffold(
      floatingActionButton: MyButtonWidget(),
    );
  }
}

// MyHomePage의 context가 아닌 새로 만든 MyButtonWidget의 context를 쓰기 위해
// FloatingActionButton을 별도의 클래스(MyButtonWidget)로 분리한다.
class MyButtonWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return FloatingActionButton(onPressed: () {
      Scaffold.of(context).showBottomSheet(
        (context) => Text('Flutter From Zero to Hero'),
      );
    });
  }
}
```
![[위젯 트리 예시 2.png|center|500]]
```dart
// 아니면 아래처럼 Builder()를 이용해 코드를 간략화할 수도 있다.
void main() {
  runApp(
    MaterialApp(
      home: MyHomePage(),
    ),
  );
}

class MyHomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      // Builder 위젯은 본인이 가진 context를 Scaffold.of에 전달한다.
      floatingActionButton: Builder(builder: (context) {
        return FloatingActionButton(onPressed: () {
          Scaffold.of(context).showBottomSheet(
            (context) => Text('Flutter From Zero to Hero'),
          );
        });
      }),
    );
  }
}
```
![[위젯 트리 예시 3.png|center|500]]

# Builder 위젯
- `Builder` 위젯은 **새로운 `BuildContext`를 생성**하기 위해 사용 한다.    
    - Flutter 위젯 트리의 `BuildContext`는 부모 위젯에서 파생된다.
    - 하지만, 특정 위젯 트리 안에서 새 컨텍스트가 필요할 때가 있다.
    - 예를 들어, `Scaffold.of(context)` 또는 `Theme.of(context)` 같은 메서드는 해당 컨텍스트가 `Scaffold`나 `Theme`의 자식이어야 작동한다.
    - 하지만 부모 컨텍스트에서는 이를 참조할 수 없는 경우가 있다.
- 주로 특정 위젯 트리에서 상위 `BuildContext`와 분리된 새로운 컨텍스트를 필요로 할 때 사용된다.
    - 특정 위젯에서 부모의 컨텍스트에 영향을 주지 않고 하위 위젯 트리를 렌더링하고자 할 때 사용
- 예시1: `Scaffold.of(context)` 사용
    - `caffold.of(context)`는 위젯 트리가 `Scaffold` 아래에 있는 `BuildContext`에서만 호출 가능하다.
    - 하지만 트리 상단에서 접근하려 하면 오류가 발생한다. 이 경우 `Builder`를 사용하여 해결할 수 있다.
    ```dart
    import 'package:flutter/material.dart';
    
    void main() {
      runApp(MyApp());
    }
    
    class MyApp extends StatelessWidget {
      @override
      Widget build(BuildContext context) {
        return MaterialApp(
          home: Scaffold(
            appBar: AppBar(title: Text("Builder Example")),
            body: Center(
              child: Builder(
                builder: (context) {
                  return ElevatedButton(
                    onPressed: () {
                      // Scaffold.of(context)는 Builder 안에서만 안전하게 호출 가능
                      ScaffoldMessenger.of(context).showSnackBar(
                        SnackBar(content: Text("Hello from Builder!")),
                      );
                    },
                    child: Text("Show SnackBar"),
                  );
                },
              ),
            ),
          ),
        );
      }
    }
    
    ```
    - `Builder`는 새로운 `BuildContext`를 생성하며, 이 컨텍스트는 `Scaffold` 위젯의 하위에 위치하게 된다.
    - 따라서 `Scaffold.of(context)`를 안전하게 호출할 수 있다.
- 예시2: `Theme.of(context)` 사용    
    - 마찬가지로 `Theme.of(context)`도 현재 컨텍스트가 `Theme`의 하위에 있어야 제대로 작동한다.
    - `Builder`를 사용하여 이를 보장할 수 있다.    
    ```dart
    import 'package:flutter/material.dart';
    
    void main() {
      runApp(MyApp());
    }
    
    class MyApp extends StatelessWidget {
      @override
      Widget build(BuildContext context) {
        return MaterialApp(
          theme: ThemeData(primarySwatch: Colors.blue),
          home: Scaffold(
            appBar: AppBar(title: Text("Builder Example")),
            body: Center(
              child: Builder(
                builder: (context) {
                  return Text(
                    "Primary Color: ${Theme.of(context).primaryColor}",
                    style: TextStyle(fontSize: 18),
                  );
                },
              ),
            ),
          ),
        );
      }
    }
    
    ```
    - `Builder`로 새로운 컨텍스트를 생성하면, 해당 컨텍스트는 `Theme` 위젯의 하위에 위치하게 된다.
    - 이로 인해 `Theme.of(context)`를 문제없이 호출할 수 있다/
- 복잡한 위젯 트리에서 컨텍스트 관리
    - 위젯 트리가 복잡하거나 `BuildContext`가 중첩된 구조에서는 특정 컨텍스트에 접근하는 데 어려움이 있을 수 있다.
    - 이때 `Builder`를 사용하여 명시적으로 컨텍스트를 생성할 수 있다.    
    ```dart
    import 'package:flutter/material.dart';
    
    void main() {
      runApp(MyApp());
    }
    
    class MyApp extends StatelessWidget {
      @override
      Widget build(BuildContext context) {
        return MaterialApp(
          home: MyHomePage(),
        );
      }
    }
    
    class MyHomePage extends StatelessWidget {
      @override
      Widget build(BuildContext context) {
        return Scaffold(
          appBar: AppBar(title: Text("Nested Builder Example")),
          body: Builder(
            builder: (outerContext) {
              return Center(
                child: ElevatedButton(
                  onPressed: () {
                    ScaffoldMessenger.of(outerContext).showSnackBar(
                      SnackBar(content: Text("SnackBar from outer Builder!")),
                    );
                  },
                  child: Text("Show SnackBar"),
                ),
              );
            },
          ),
        );
      }
    }
    
    ```
    - `Builder` 위젯은 새로운 `BuildContext`를 생성하여 상위 컨텍스트와 분리된 환경을 제공한다.
    - 주로 `Scaffold.of(context)`나 `Theme.of(context)` 같은 메서드 호출 시 상위 위젯의 컨텍스트에 접근할 수 없는 문제를 해결하는 데 사용된다.
    - 복잡한 위젯 트리에서 특정 컨텍스트를 명시적으로 관리할 때 유용하다.
    - 참고로 `ScaffoldMessenger.of(context)` 메서드도 `context`가 반드시 `Scaffold`의 하위에 있는 컨텍스트여야만 정상적으로 작동한다.

# What if there were 2 Scaffolds?
```dart
import 'package:flutter/material.dart';

void main() {
  runApp(
    MaterialApp(
      home: MyHomePage(),
    ),
  );
}

class MyHomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Color(0xFF1B5E20), // green
      body: Scaffold(
        backgroundColor: Color(0xffe91e63), // pink
        floatingActionButton: Builder(builder: (context) {
          return FloatingActionButton(onPressed: () {
            print(Scaffold.of(context).widget.backgroundColor); // Color(0xffe91e63), 즉 pink가 출력됨
          });
        }),
      ),
    );
  }
}
```
- 부모 Scaffold가 두 개 이상일 경우 가장 가까운 Scaffold가 전달된다.
	![[위젯 트리 예시 4.png|center|500]]
- Theme.of(context), MediaQuery.of(context), Navigator.of(context) and Provider.of(context)와 같이 context를 매개변수로 받는 of 함수가 많이 존재한다.